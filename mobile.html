<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>åäººå¡è½¦åä¼šè‹±è¯­è¯„ä¼°è®­ç»ƒ Â· æ‰‹æœºç‰ˆ</title>

<style>
:root{--bg:#0b1220;--card:#0f1b2e;--line:#1f2a44;--text:#e6eef9;--muted:#9fb1c9}
*{box-sizing:border-box}
body{margin:0;background:#0b1220;color:var(--text);font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

header{position:sticky;top:0;z-index:10;background:#0f1b2e;border-bottom:1px solid var(--line)}
.wrap{max-width:800px;margin:0 auto;padding:0 12px}
.h-bar{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap;padding:10px 0}
h1{font-size:16px;margin:0;flex:1 0 100%}
input[type="search"]{flex:1;border:1px solid var(--line);background:#0b1629;color:var(--text);padding:8px;border-radius:8px;min-width:140px}
select.btn{padding:6px 8px;background:#10213a;border:1px solid var(--line);color:var(--text);border-radius:8px}
.slider-wrap{display:flex;align-items:center;gap:4px}
.slider-wrap input[type="range"]{width:100px}

main{padding:14px 0 40px}
section{margin:14px 0}
h2{font-size:17px;margin:0 0 6px}
.small{font-size:12px;color:var(--muted)}

/* å¡ç‰‡æ ·å¼ */
.list{display:grid;gap:10px}
.card{
  background:#0f1b2e;border:1px solid var(--line);border-radius:14px;
  padding:10px 12px;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center
}
.en{font-weight:700}
.meta{grid-column:1 / -1;color:var(--muted);font-size:13px;display:flex;gap:10px;flex-wrap:wrap}
.btn{border:1px solid var(--line);background:#10213a;color:var(--text);padding:6px 10px;border-radius:10px;cursor:pointer}

/* æ–‡æœ¬æ¢è¡Œï¼Œæœç»æ¨ªå‘æ»šåŠ¨ */
.en,.zh,.pr{word-break:break-word;overflow-wrap:anywhere}

/* è¡¨æ ¼æ ·å¼ */
table{width:100%;border-collapse:collapse;background:#0f1b2e;border:1px solid var(--line);border-radius:12px;overflow:hidden;table-layout:auto;word-break:break-word}
th,td{padding:8px;border-bottom:1px solid #1a2948;vertical-align:top}
th{background:#0e1a31;text-align:left;font-weight:600}
tr:last-child td{border-bottom:none}
tbody td:last-child{text-align:center;white-space:nowrap}
.btn.table-btn{padding:4px 8px;border-radius:8px}
.hint{color:var(--muted);font-size:12px}
</style>
</head>

<body>
<header>
  <div class="wrap h-bar">
    <h1>åäººå¡è½¦åä¼šè‹±è¯­è¯„ä¼°è®­ç»ƒ Â· æ‰‹æœºç‰ˆ</h1>
    <!-- ç»Ÿä¸€ä¸€ä¸ªæœç´¢æ¡† -->
    <input id="globalSearch" type="search" placeholder="æœç´¢è‹±æ–‡ / ä¸­æ–‡ / è¯»éŸ³â€¦" aria-label="æœç´¢ï¼ˆå¡ç‰‡+è¡¨æ ¼ï¼‰">
    <select id="voiceSel" class="btn" aria-label="è¯­éŸ³é€‰æ‹©"><option>åŠ è½½è¯­éŸ³ä¸­â€¦</option></select>
    <div class="slider-wrap">
      <label class="small" for="rateCtl">é€Ÿ <span id="rateOut">0.95</span></label>
      <input id="rateCtl" type="range" min="0.6" max="1.4" step="0.05" value="0.95"/>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="essential">
    <h2>å¿…å¤‡è¯ä»¶ä¸å•æ®è¯æ±‡</h2>
    <div id="listEssential" class="list"></div>
    <p class="small">ç‚¹å‡» ğŸ”Š æœ—è¯»è‹±æ–‡ï¼ˆç¾å¼è‹±è¯­ï¼Œç”·å£°ä¼˜å…ˆï¼‰ã€‚</p>

    <!-- è¡¨æ ¼ç‰ˆï¼ˆä½ çš„éœ€æ±‚é‡Œä¿ç•™ï¼‰ -->
    <h2>å¿…å¤‡è¯ä»¶ä¸å•æ®</h2>
    <table id="tblEssential" aria-label="å¿…å¤‡è¯ä»¶ä¸å•æ®è¡¨">
      <thead><tr><th>è‹±æ–‡</th><th>ä¸­æ–‡</th><th>è¯»éŸ³</th><th>ğŸ”Š</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="stop">
    <h2>æ‰§æ³•/æ‹¦æ£€å¸¸ç”¨è¯</h2>
    <div id="listStop" class="list"></div>
  </section>

  <section id="ops">
    <h2>è¿è¥ä¸è¡Œç¨‹ç›¸å…³ç”¨è¯­</h2>
    <div id="listOps" class="list"></div>
  </section>

  <section id="inspect">
    <h2>æ£€æŸ¥ä¸è®¾å¤‡ï¼ˆInspection &amp; Equipmentï¼‰</h2>
    <div id="listInspect" class="list"></div>
  </section>

  <section id="maint">
    <h2>ç»´ä¿®ä¸éƒ¨ä»¶ï¼ˆMaintenance &amp; Partsï¼‰</h2>
    <div id="listMaint" class="list"></div>
  </section>

  <section id="dialog">
    <h2>æ‹¦æ£€æƒ…æ™¯å¯¹è¯ï¼ˆOfficer â€“ Driverï¼‰</h2>
    <div id="listDialog" class="list"></div>
  </section>

  <section id="states">
    <h2>ç¾å›½å„å·</h2>
    <div id="listStates" class="list"></div>

    <!-- è¡¨æ ¼ç‰ˆï¼ˆä¿ç•™ï¼‰ -->
    <table id="tblStates" aria-label="ç¾å›½å„å·è¡¨">
      <thead><tr><th>State</th><th>ä¸­æ–‡</th><th>è¯»éŸ³</th><th>ğŸ”Š</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<!-- æ•°æ®ä¸å…¬å…±é€»è¾‘ï¼ˆå«é—¨ç¦/æœ—è¯»ï¼‰ -->
<script src="data.js"></script>
<script src="common.js"></script>
<script>
/* ===== åŸºç¡€å·¥å…· ===== */
const safeArr = a => Array.isArray(a) ? a : [];

/* å¡ç‰‡å·¥å‚ï¼ˆå®‰å…¨ DOM æ¸²æŸ“ï¼‰ */
function makeCard({en="", zh="", hint=""}) {
  const div = document.createElement('div');
  div.className = 'card';

  const title = document.createElement('div');
  title.className = 'en';
  title.textContent = en;

  const btn = document.createElement('button');
  btn.className = 'btn';
  btn.setAttribute('aria-label', `æœ—è¯» ${en}`);
  btn.textContent = 'ğŸ”Š';
  btn.addEventListener('click', () => speakText(en || ''));

  const meta = document.createElement('div');
  meta.className = 'meta';
  const zhSpan = document.createElement('span');
  zhSpan.className = 'zh';
  zhSpan.textContent = `ä¸­æ–‡ï¼š${zh || 'â€”'}`;
  const prSpan = document.createElement('span');
  prSpan.className = 'pr';
  prSpan.textContent = `è¯»éŸ³ï¼š${hint || 'â€”'}`;
  meta.appendChild(zhSpan);
  meta.appendChild(prSpan);

  div.appendChild(title);
  div.appendChild(btn);
  div.appendChild(meta);

  // ç»Ÿä¸€æœç´¢ç¼“å­˜
  div.dataset.search = [en, zh, hint].join(' ').toLowerCase();
  return div;
}

function makeDialogCard({en="", zh=""}) {
  const div = document.createElement('div');
  div.className = 'card';

  const title = document.createElement('div');
  title.className = 'en';
  title.textContent = en;

  const btn = document.createElement('button');
  btn.className = 'btn';
  btn.setAttribute('aria-label', 'æœ—è¯»å¥å­');
  btn.textContent = 'ğŸ”Š';
  btn.addEventListener('click', () => speakText(en || ''));

  const meta = document.createElement('div');
  meta.className = 'meta';
  const zhSpan = document.createElement('span');
  zhSpan.className = 'zh';
  zhSpan.textContent = `ä¸­æ–‡ï¼š${zh || 'â€”'}`;
  meta.appendChild(zhSpan);

  div.appendChild(title);
  div.appendChild(btn);
  div.appendChild(meta);

  div.dataset.search = [en, zh].join(' ').toLowerCase();
  return div;
}

/* æ¸²æŸ“åˆ—è¡¨ */
function renderList(container, rows) {
  container.innerHTML = '';
  safeArr(rows).forEach(r => container.appendChild(makeCard(r)));
}

/* ===== è¡¨æ ¼å®‰å…¨æ¸²æŸ“ï¼ˆä½¿ç”¨ essentialData/statesData çš„ cn/pr å­—æ®µï¼‰ ===== */
function renderRows(tbody, rows){
  tbody.innerHTML = '';
  safeArr(rows).forEach(r => {
    const tr = document.createElement('tr');

    const tdEn = document.createElement('td'); tdEn.textContent = r.en || '';
    const tdCn = document.createElement('td'); tdCn.textContent = r.cn || r.zh || '';
    const tdPr = document.createElement('td'); tdPr.className = 'hint'; tdPr.textContent = r.pr || r.hint || '';

    const tdBtn = document.createElement('td');
    const btn = document.createElement('button');
    btn.className = 'btn table-btn';
    btn.textContent = 'ğŸ”Š';
    btn.setAttribute('aria-label', `æœ—è¯» ${r.en || ''}`);
    btn.addEventListener('click', () => speakText(r.en || ''));
    tdBtn.appendChild(btn);

    tr.appendChild(tdEn);
    tr.appendChild(tdCn);
    tr.appendChild(tdPr);
    tr.appendChild(tdBtn);
    tbody.appendChild(tr);
  });
}

function initTables(){
  renderRows(document.querySelector('#tblEssential tbody'), safeArr(window.essentialData));
  renderRows(document.querySelector('#tblStates tbody'),    safeArr(window.statesData));
}

/* ===== å¡ç‰‡åˆå§‹åŒ– ===== */
function runApp(){
  const D = window.FMCSA_DATA || {};
  renderList(document.getElementById('listEssential'), safeArr(D.vocab));
  renderList(document.getElementById('listStop'),      safeArr(D.stopWords));
  renderList(document.getElementById('listOps'),       safeArr(D.opsWords));
  renderList(document.getElementById('listInspect'),   safeArr(D.inspectWords));
  renderList(document.getElementById('listMaint'),     safeArr(D.maintWords));

  const dialogBox = document.getElementById('listDialog');
  dialogBox.innerHTML = '';
  safeArr(D.dialogs).forEach(d => dialogBox.appendChild(makeDialogCard(d)));

  renderList(document.getElementById('listStates'),    safeArr(D.states));
}

/* ===== ç»Ÿä¸€æœç´¢ï¼ˆä¸€ä¸ªè¾“å…¥ â†’ è¿‡æ»¤å¡ç‰‡ + è¡¨æ ¼ï¼‰ ===== */
function unifyFilter(){
  const q = (document.getElementById('globalSearch').value || '').trim().toLowerCase();

  // å¡ç‰‡
  document.querySelectorAll('.card').forEach(card => {
    const ok = !q || (card.dataset.search || '').includes(q);
    card.style.display = ok ? '' : 'none';
  });

  // è¡¨æ ¼
  document.querySelectorAll('table tbody tr').forEach(tr => {
    const match = Array.from(tr.cells).some(td => (td.textContent||'').toLowerCase().includes(q));
    tr.style.display = match ? '' : 'none';
  });
}

/* ===== å¯åŠ¨é¡ºåºï¼ˆä¸€æ¬¡æ€§é—¨ç¦ï¼‰ ===== */
function bootAll(){
  runApp();
  initTables();
}
gatedInit(bootAll); // é€šè¿‡é—¨ç¦åç»Ÿä¸€å¯åŠ¨

/* ===== äº‹ä»¶ä¸æ§ä»¶ ===== */
document.addEventListener('DOMContentLoaded', () => {
  // TTS æ§ä»¶ï¼ˆä¾èµ– common.jsï¼‰
  wireTtsControls('voiceSel','rateCtl','rateOut');

  // æœç´¢äº‹ä»¶
  const gs = document.getElementById('globalSearch');
  gs.addEventListener('input', unifyFilter);
  gs.addEventListener('keydown', e => {
    if (e.key === 'Escape'){ gs.value=''; unifyFilter(); }
  });
});
</script>
</body>
</html>
