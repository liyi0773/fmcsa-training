<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>华人卡车协会英语评估训练 · 手机版</title>

<style>
:root{--bg:#0b1220;--card:#0f1b2e;--line:#1f2a44;--text:#e6eef9;--muted:#9fb1c9}
*{box-sizing:border-box}
body{margin:0;background:#0b1220;color:var(--text);font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

header{position:sticky;top:0;z-index:10;background:#0f1b2e;border-bottom:1px solid var(--line)}
.wrap{max-width:800px;margin:0 auto;padding:0 12px}
.h-bar{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap;padding:10px 0}
h1{font-size:16px;margin:0;flex:1 0 100%}
input[type="search"]{flex:1;border:1px solid var(--line);background:#0b1629;color:var(--text);padding:8px;border-radius:8px;min-width:140px}
select.btn{padding:6px 8px;background:#10213a;border:1px solid var(--line);color:var(--text);border-radius:8px}
.slider-wrap{display:flex;align-items:center;gap:4px}
.slider-wrap input[type="range"]{width:100px}

main{padding:14px 0 40px}
section{margin:14px 0}
h2{font-size:17px;margin:0 0 6px}
.small{font-size:12px;color:var(--muted)}

/* 卡片样式 */
.list{display:grid;gap:10px}
.card{
  background:#0f1b2e;border:1px solid var(--line);border-radius:14px;
  padding:10px 12px;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center
}
.en{font-weight:700}
.meta{grid-column:1 / -1;color:var(--muted);font-size:13px;display:flex;gap:10px;flex-wrap:wrap}
.btn{border:1px solid var(--line);background:#10213a;color:var(--text);padding:6px 10px;border-radius:10px;cursor:pointer}

/* 文本换行，杜绝横向滚动 */
.en,.zh,.pr{word-break:break-word;overflow-wrap:anywhere}

/* 表格样式 */
table{width:100%;border-collapse:collapse;background:#0f1b2e;border:1px solid var(--line);border-radius:12px;overflow:hidden;table-layout:auto;word-break:break-word}
th,td{padding:8px;border-bottom:1px solid #1a2948;vertical-align:top}
th{background:#0e1a31;text-align:left;font-weight:600}
tr:last-child td{border-bottom:none}
tbody td:last-child{text-align:center;white-space:nowrap}
.btn.table-btn{padding:4px 8px;border-radius:8px}
.hint{color:var(--muted);font-size:12px}
</style>
</head>

<body>
<header>
  <div class="wrap h-bar">
    <h1>华人卡车协会英语评估训练 · 手机版</h1>
    <!-- 统一一个搜索框 -->
    <input id="globalSearch" type="search" placeholder="搜索英文 / 中文 / 读音…" aria-label="搜索（卡片+表格）">
    <select id="voiceSel" class="btn" aria-label="语音选择"><option>加载语音中…</option></select>
    <div class="slider-wrap">
      <label class="small" for="rateCtl">速 <span id="rateOut">0.95</span></label>
      <input id="rateCtl" type="range" min="0.6" max="1.4" step="0.05" value="0.95"/>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="essential">
    <h2>必备证件与单据词汇</h2>
    <div id="listEssential" class="list"></div>
    <p class="small">点击 🔊 朗读英文（美式英语，男声优先）。</p>

    <!-- 表格版（你的需求里保留） -->
    <h2>必备证件与单据</h2>
    <table id="tblEssential" aria-label="必备证件与单据表">
      <thead><tr><th>英文</th><th>中文</th><th>读音</th><th>🔊</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="stop">
    <h2>执法/拦检常用词</h2>
    <div id="listStop" class="list"></div>
  </section>

  <section id="ops">
    <h2>运营与行程相关用语</h2>
    <div id="listOps" class="list"></div>
  </section>

  <section id="inspect">
    <h2>检查与设备（Inspection &amp; Equipment）</h2>
    <div id="listInspect" class="list"></div>
  </section>

  <section id="maint">
    <h2>维修与部件（Maintenance &amp; Parts）</h2>
    <div id="listMaint" class="list"></div>
  </section>

  <section id="dialog">
    <h2>拦检情景对话（Officer – Driver）</h2>
    <div id="listDialog" class="list"></div>
  </section>

  <section id="states">
    <h2>美国各州</h2>
    <div id="listStates" class="list"></div>

    <!-- 表格版（保留） -->
    <table id="tblStates" aria-label="美国各州表">
      <thead><tr><th>State</th><th>中文</th><th>读音</th><th>🔊</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<!-- 数据与公共逻辑（含门禁/朗读） -->
<script src="data.js"></script>
<script src="common.js"></script>
<script>
/* ===== 基础工具 ===== */
const safeArr = a => Array.isArray(a) ? a : [];

/* 卡片工厂（安全 DOM 渲染） */
function makeCard({en="", zh="", hint=""}) {
  const div = document.createElement('div');
  div.className = 'card';

  const title = document.createElement('div');
  title.className = 'en';
  title.textContent = en;

  const btn = document.createElement('button');
  btn.className = 'btn';
  btn.setAttribute('aria-label', `朗读 ${en}`);
  btn.textContent = '🔊';
  btn.addEventListener('click', () => speakText(en || ''));

  const meta = document.createElement('div');
  meta.className = 'meta';
  const zhSpan = document.createElement('span');
  zhSpan.className = 'zh';
  zhSpan.textContent = `中文：${zh || '—'}`;
  const prSpan = document.createElement('span');
  prSpan.className = 'pr';
  prSpan.textContent = `读音：${hint || '—'}`;
  meta.appendChild(zhSpan);
  meta.appendChild(prSpan);

  div.appendChild(title);
  div.appendChild(btn);
  div.appendChild(meta);

  // 统一搜索缓存
  div.dataset.search = [en, zh, hint].join(' ').toLowerCase();
  return div;
}

function makeDialogCard({en="", zh=""}) {
  const div = document.createElement('div');
  div.className = 'card';

  const title = document.createElement('div');
  title.className = 'en';
  title.textContent = en;

  const btn = document.createElement('button');
  btn.className = 'btn';
  btn.setAttribute('aria-label', '朗读句子');
  btn.textContent = '🔊';
  btn.addEventListener('click', () => speakText(en || ''));

  const meta = document.createElement('div');
  meta.className = 'meta';
  const zhSpan = document.createElement('span');
  zhSpan.className = 'zh';
  zhSpan.textContent = `中文：${zh || '—'}`;
  meta.appendChild(zhSpan);

  div.appendChild(title);
  div.appendChild(btn);
  div.appendChild(meta);

  div.dataset.search = [en, zh].join(' ').toLowerCase();
  return div;
}

/* 渲染列表 */
function renderList(container, rows) {
  container.innerHTML = '';
  safeArr(rows).forEach(r => container.appendChild(makeCard(r)));
}

/* ===== 表格安全渲染（使用 essentialData/statesData 的 cn/pr 字段） ===== */
function renderRows(tbody, rows){
  tbody.innerHTML = '';
  safeArr(rows).forEach(r => {
    const tr = document.createElement('tr');

    const tdEn = document.createElement('td'); tdEn.textContent = r.en || '';
    const tdCn = document.createElement('td'); tdCn.textContent = r.cn || r.zh || '';
    const tdPr = document.createElement('td'); tdPr.className = 'hint'; tdPr.textContent = r.pr || r.hint || '';

    const tdBtn = document.createElement('td');
    const btn = document.createElement('button');
    btn.className = 'btn table-btn';
    btn.textContent = '🔊';
    btn.setAttribute('aria-label', `朗读 ${r.en || ''}`);
    btn.addEventListener('click', () => speakText(r.en || ''));
    tdBtn.appendChild(btn);

    tr.appendChild(tdEn);
    tr.appendChild(tdCn);
    tr.appendChild(tdPr);
    tr.appendChild(tdBtn);
    tbody.appendChild(tr);
  });
}

function initTables(){
  renderRows(document.querySelector('#tblEssential tbody'), safeArr(window.essentialData));
  renderRows(document.querySelector('#tblStates tbody'),    safeArr(window.statesData));
}

/* ===== 卡片初始化 ===== */
function runApp(){
  const D = window.FMCSA_DATA || {};
  renderList(document.getElementById('listEssential'), safeArr(D.vocab));
  renderList(document.getElementById('listStop'),      safeArr(D.stopWords));
  renderList(document.getElementById('listOps'),       safeArr(D.opsWords));
  renderList(document.getElementById('listInspect'),   safeArr(D.inspectWords));
  renderList(document.getElementById('listMaint'),     safeArr(D.maintWords));

  const dialogBox = document.getElementById('listDialog');
  dialogBox.innerHTML = '';
  safeArr(D.dialogs).forEach(d => dialogBox.appendChild(makeDialogCard(d)));

  renderList(document.getElementById('listStates'),    safeArr(D.states));
}

/* ===== 统一搜索（一个输入 → 过滤卡片 + 表格） ===== */
function unifyFilter(){
  const q = (document.getElementById('globalSearch').value || '').trim().toLowerCase();

  // 卡片
  document.querySelectorAll('.card').forEach(card => {
    const ok = !q || (card.dataset.search || '').includes(q);
    card.style.display = ok ? '' : 'none';
  });

  // 表格
  document.querySelectorAll('table tbody tr').forEach(tr => {
    const match = Array.from(tr.cells).some(td => (td.textContent||'').toLowerCase().includes(q));
    tr.style.display = match ? '' : 'none';
  });
}

/* ===== 启动顺序（一次性门禁） ===== */
function bootAll(){
  runApp();
  initTables();
}
gatedInit(bootAll); // 通过门禁后统一启动

/* ===== 事件与控件 ===== */
document.addEventListener('DOMContentLoaded', () => {
  // TTS 控件（依赖 common.js）
  wireTtsControls('voiceSel','rateCtl','rateOut');

  // 搜索事件
  const gs = document.getElementById('globalSearch');
  gs.addEventListener('input', unifyFilter);
  gs.addEventListener('keydown', e => {
    if (e.key === 'Escape'){ gs.value=''; unifyFilter(); }
  });
});
</script>
</body>
</html>
